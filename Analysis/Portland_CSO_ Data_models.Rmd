---
title: "Casco Bay CSO Data Analysis, Patterns with Rainfall"
author: Curtis C. Bohlen, Casco Bay Estuary Partnership
output:
  github_document:
    toc: true
    fig_width: 7
    fig_height: 5
---

<img
    src="https://www.cascobayestuary.org/wp-content/uploads/2014/04/logo_sm.jpg"
    style="position:absolute;top:10px;right:50px;" />

```{r, echo = FALSE}
  knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

#Load Libraries
```{r load_libraries}
library(tidyverse)
library(gridExtra)
library(corrplot)

library(CBEPgraphics)
load_cbep_fonts()
theme_set(theme_cbep())

```

# Load Data
## Establish Folder References
```{r folder_references}
sibfldnm <- 'Derived_Data'
parent   <- dirname(getwd())
sibling  <- file.path(parent,sibfldnm)

dir.create(file.path(getwd(), 'figures'), showWarnings = FALSE)
```

## Load Core Data
```{r load_data}
fn <-'Portland_CSO_data_2015_2019.csv'
fpath <- file.path(sibling, fn)
the_data <- read_csv(fpath, col_types = 
                       cols(.default = col_double(),
                                 firstdate = col_date(format = ""),
                                 lastdate = col_date(format = ""))) %>%
  select (-event)    # event only applies within years, and has no purpose here.

```

## Load Locations Lookup Table
```{r load_locations}
fn <-'Portland_Locations.csv'
fpath <- file.path(sibling, fn)
locations_lookup <- read_csv(fpath, col_types = 
                             cols(CSO = col_character(),
                                  Location = col_character()))
```

## Load Weather Data
### Establish Folder Reference
```{r folder_references_2}
sibfldnm <- 'Original_Data'
parent   <- dirname(getwd())
sibling  <- file.path(parent,sibfldnm)
```

### Access data
We extract annual Precipitation Totals (in mm), and Annual Days with more than
one tenth of an inch (2.5mm), and one inch (25.4mm) of rain from the annual
weather summaries from NOAA.
```{r rain_data}
fn <-'Annual_Weather_PWD.csv'
fpath <- file.path(sibling, fn)
rain_data <- read_csv(fpath, col_types =
                       cols(date = col_datetime(format = ""),
                            datatype = col_character(),
                            value = col_double(),
                            attributes = col_character(),
                            station = col_skip())) %>%
  mutate(Year = as.integer(format(date, format = '%Y'))) %>%
  filter (datatype %in% c('PRCP', 'DP10', 'DP1X')) %>%
  select(Year, datatype, value) %>%
  pivot_wider(names_from = datatype, values_from = value) %>%
  rename(Precip_mm = PRCP, GT0.1 = DP10, GT1.0 = DP1X) %>%
  mutate(Precip_in = Precip_mm / 25.4) %>%
  filter(Year > 1996)
```

## Calculate Totals by Year
The CALCULATED total volumes here incorporate some data corrections from 2019
that were missed in the source Excel File, so `eventtotal` and `calcvolume` do
not match exactly.
```{r annual_totals}
totals_by_year <- the_data %>%
  mutate(calcvolume  = rowSums(.[grep("CSO", names(.))], na.rm = TRUE)) %>%
  select(-contains('CSO')) %>%
  group_by(Year) %>%
  summarize(annualstormprecip = sum(totalprecip),
            annualreportvol = sum(eventtotal),
            annualcalcvol =  sum(calcvolume),
            annualevents = sum(! is.na(calcvolume)),
            .groups = 'drop') %>%
  left_join(rain_data)
totals_by_year
```

### Total EEWTF Overflow
Data on total annual EEWWTF bypass flows was copied by hand from each report
from Portland Water District.

Note that the total CSO volume we show here for 2019 is slightly different
from the total reported in the Excel file, as that file included two events 
from January of 2020.  We have dropped those from our analyses.  It is not clear
whether that invalidates the comparison to the EEWTF bypass flows.

```{r}
EEWTF_overflows <- tribble(
~Year, ~'Total CSO',	~'EEWTF',
2015,	  221085900,    165380000,
2016,	  318359690,	  178190000,
2017,	  164977000,	  211460000,
2018,   290485700,    337570000,
2019,   127921700,	  248450000
)
EEWTF_overflows <- EEWTF_overflows %>%
  mutate(Total           = `Total CSO` + EEWTF,
         `EEWTF Percent` = round(EEWTF/Total,3)*100)

EEWTF_overflows %>%
  mutate(`Total CSO` = round(`Total CSO`/(10^6),2),
         EEWTF       = round( EEWTF     /(10^6),2),
         Total       = round( Total     /(10^6),2)) %>%
  knitr::kable(align = c('lrrrc'))
```
For comparison purposes, it is worth recalling that the EEWTF is licensed to
discharge ~ 18 MGD.  On an annual basis, that would work out to 
$18 \times 365 = 6,570$ million gallons, or substantially more than an order of 
magnitude higher.

## Combine Annual Totals
```{r}
totals_by_year <- totals_by_year %>%
  left_join(EEWTF_overflows, by = 'Year') %>%
  select(-annualreportvol, -Precip_mm, -Total, -`EEWTF Percent`)
```

## Revised data
```{r]}
CSO <- the_data %>% 
  select(firstdate, totalprecip, maxprecip, everything()) %>%

  select (firstdate, Year, days, everything(), -eventtotal, -lastdate) %>%
  pivot_longer(cols = CSO_002:CSO_042,
               names_to = 'CSO',
               values_to = 'Volume') %>%
  mutate(Volume = Volume/(10^6)) %>%
  left_join(locations_lookup, by = 'CSO') %>%
  group_by(Year, CSO) %>%
  summarize(Location = first(Location),
            Events = sum(Volume>0, na.rm = TRUE),
            Volume = sum(Volume, na.rm = TRUE),
            .groups = 'drop') %>%
```

# Exploratory Data Analysis
## Correlations by Event
```{r correlation_figure}
cors <- totals_by_event %>%
  select(3:8) %>%
  cor(use = 'pairwise')
corrplot(cors, method="circle", type = 'upper')
rm(cors)
```

So all metrics of storm intensity and CSO magnitude are positively correlated.
Event-related CSO volume is most closely correlated with total precipitation
rather than the peak storm intensity.


#Looking for patterns in relationship to rainfall
##Annual rainfall Patterns
Note a large storm in 2015.
```{r}
plt <- the_data %>%
  ggplot(aes(Year, totalprecip)) +
  geom_violin() +
  ylab("Total Precipitation During Storm Event (in)") +
  scale_y_log10(limits =c(0.1, 10))
plt
```

```{r}
plt <- ggplot(wide.data) + aes(YEAR, maxprecip) + geom_violin() + ylab("Maximum Precipitation During Storm Event (in)") + scale_y_log10(limits =c(0.05, 5))
plt
```

##Seasonal Rainfall Patterns?
```{r}
tmp <- wide.data %>% select(startdate, totprecip, maxprecip, TOTAL, YEAR) %>% mutate(Month = factor(format(startdate, "%m"),
           labels = c("jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec")))
plt <- ggplot(tmp) + aes(Month, totprecip, color = YEAR) + geom_point() +  
  ylab("Precipitation During Storm Event (in)") + scale_y_log10(limits =c(0.05, 5))
plt
rm(tmp)
```

```{r}
tmp <- wide.data %>% select(startdate, totprecip, maxprecip, TOTAL, YEAR) %>% mutate(Month =as.integer(format(startdate, "%m")))
plt <- ggplot(tmp)  + geom_point(aes(Month, totprecip, color = YEAR)) +  geom_smooth(aes(Month, totprecip)) +
  ylab("Precipitation During Storm Event (in)") + scale_y_log10(limits =c(0.05, 5))
plt
rm(tmp)
```

##Relationship between total and maximum rainfall
```{r}
plt <- ggplot(wide.data) + geom_point(aes(maxprecip, totprecip, color = YEAR)) + geom_smooth(aes(maxprecip, totprecip), method = 'lm')
plt <- plt + ylab("Total Precipitation During Storm Event (in)") + xlab("Peak Hourly Precipitation During Storm Event (in)")
plt <- plt + scale_y_log10() + scale_x_log10()
plt
```

#Relationship between Discharges and Rainfall
##Number of Discharging Outfalls
```{r}
plt <- ggplot(wide.data) 
plt <- plt + geom_point(aes(maxprecip, COUNT, color = YEAR)) + geom_smooth(aes(maxprecip, COUNT), method = "lm")
plt <- plt + scale_x_log10(breaks = c(0.01, 0.05, 0.1, 0.5, 1, 1.5, 2))
plt <- plt + ylab('Number of Active Outfalls') + xlab('Peak Hourly Precipitation During Event (in)')
plt
```

```{r}
plt <- ggplot(wide.data) 
plt <- plt + geom_point(aes(totprecip, COUNT, color = YEAR)) + geom_smooth(aes(totprecip, COUNT), method = "lm")
plt <- plt + scale_x_log10(breaks = c(0.01, 0.05, 0.1, 0.5, 1, 1.5, 2,5,10))
plt <- plt + ylab('Number of Active Outfalls') + xlab('Total Precipitation During Event (in)')
plt
```

##Discharge VOlumes by Rainfall
```{r}
plt <- ggplot(wide.data)  + geom_point(aes(maxprecip, TOTAL/1000000, color = YEAR)) + geom_smooth(aes(maxprecip, TOTAL/1000000), method = "lm")
plt <- plt + scale_x_log10() + scale_y_log10(breaks = c(0.1,1,10,100))
plt <- plt + ylab('Discharge(MG) Per event') + xlab('Peak Hourly Precipitation During Event (in)')
plt
```

There is some weak indication of lower discharges during low rain events.


```{r}
plt <- ggplot(wide.data)  + geom_point(aes(totprecip, TOTAL/1000000, color = YEAR)) + geom_smooth(aes(totprecip, TOTAL/1000000), method = "lm")
plt <- plt + scale_y_log10(breaks = c(0.1,1,10,100)) + scale_x_log10(breaks = c(0.1,0.5,1,5,10))
plt <- plt + ylab('Discharge(MG) Per event') + xlab('Total Precipitation During Event (in)')
plt
```

So, visually, it looks like the NUMBER of CSOs discharging is determined mostly by peak discharge, but the VOLUME of discharge is more strongly influenced by TOTAL discharge.  That probably makes a lot of sense.


Can we symbolize a 3-D surface and see what it looks like?
```{r}
plt <- ggplot(wide.data) + aes(totprecip, maxprecip, color = log10(TOTAL)) + geom_point(size = 5)
plt <- plt + scale_y_log10(breaks = c(0.1,1,10,100)) + scale_x_log10(breaks = c(0.1,0.2, 0.5,1,2,5,10))
plt <- plt + ylab('Maximum hourly Rainfall during Event (in)') + xlab('Total Precipitation During Event (in)')
plt
```


#Formal Statistical modeling
##A simple linear model
First, test if both rainfall predictors are needed in a sinmple linear model
```{r}
the.lm <- lm(TOTAL~ totprecip+maxprecip, data = wide.data)
anova(the.lm)
the.lm <- lm(TOTAL~ maxprecip+totprecip, data = wide.data)
anova(the.lm)
summary(the.lm)
```
Nope, not really needed, but notice that maxprecip is only statistically important if enterd into the model before totprecip.  That suggests we should do NEARLY as well using a smplified model.

```{r}
the.lm2 <- lm(TOTAL~ totprecip, data = wide.data)
anova(the.lm2)
summary(the.lm2)
```

```{r}
AIC(the.lm)
AIC(the.lm2)
```
so, The model including both valirables is expected to be slightly better at prediction that the model with only total precip.  But historical data on total event precipitation may be easire to come by (depending on how a rainfall event is defined).  


```{r}
ps = predict(the.lm2, newdata = data.frame(totprecip = seq(0,6,0.1)), se = TRUE)
predictions <- data.frame(totprecip = seq(0,6,0.1), Discharge = ps$fit/1000000, se = ps$se.fit/1000000)
#predictions
plt <- ggplot(predictions) + aes(totprecip,Discharge)+ geom_line()
plt <- plt + geom_ribbon(aes(ymin=Discharge-se,ymax=Discharge+se),alpha=0.5, color = "blue")
#plt <- plt + geom_errorbar(aes(ymin=Discharge-se, ymax=Discharge+se), width=.1)
plt <- plt + geom_point(data = wide.data, aes(totprecip,TOTAL/1000000, color = YEAR))
plt
```

#A log-LOg model
```{r}
the.lm <- lm(log10(TOTAL)~ log10(totprecip)+log10(maxprecip), data = wide.data)
anova(the.lm)
the.lm <- lm(log10(TOTAL)~ log10(maxprecip) + log10(totprecip), data = wide.data)
anova(the.lm)
summary(the.lm)
```

Note that in THIS formulation, both precipitation variables are signigicant, so we will not simplify.
```{r}
predictors = expand.grid(totprecip = seq(0,5,0.25), maxprecip = seq(0,2.5,0.25))
ps = predict(the.lm, newdata = datafpredictors, se = TRUE)
predictions <- data.frame(predictors$totprecip, predictors$maxprecip, Discharge = ps$fit, se = ps$se.fit)
predictions
# plt <- ggplot(predictions) + aes(totprecip,Discharge)+ geom_line()
# plt <- plt + geom_ribbon(aes(ymin=Discharge-se,ymax=Discharge+se),alpha=0.5, color = "blue")
# #plt <- plt + geom_errorbar(aes(ymin=Discharge-se, ymax=Discharge+se), width=.1)
# plt <- plt + geom_point(data = wide.data, aes(totprecip,TOTAL/1000000, color = YEAR))
# plt
```


```{r}
a = expand.grid(totprecip = seq(0,5,0.25), maxprecip = seq(0,2.5,0.25))
plot(a)
```

